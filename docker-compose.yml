version: "3.8"

networks:
  oni:
    name: oni
    driver: bridge

volumes:
  postgres_data:
  opensearch_data:

services:
  db:
    restart: always
    image: postgres:13-alpine
    hostname: db
    tty: true
    environment:
      TERM: "xterm-256color"
      NODE_ENV: "production"
      POSTGRES_DB: "oni"
      POSTGRES_USER: "root"
      POSTGRES_PASSWORD: ""
      POSTGRES_HOST_AUTH_METHOD: "trust"
      PGDATA: /postgresql/data
    volumes:
      - postgres_data:/postgresql
    ports:
      - "5432:5432"

  api:
    restart: always
    image: rrkive/oni:2.0.0
    hostname: api
    tty: true
    environment:
      TERM: "xterm-256color"
      NODE_ENV: "production"
      LOG_LEVEL: "debug"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_USER: "root"
      DB_PASSWORD: ""
      DB_DATABASE: "oni"
      SEARCH_HOST: "opensearch"
    volumes:
      - ./configuration.json:/srv/configuration.json
      - ./wait-for-it.sh:/wait-for-it.sh
      - /opt/storage/oni:/opt/storage/oni
    ports:
      - "8080:8080"
    command: ["/wait-for-it.sh", "db:5432", "-t", "20", "opensearch:9200", "-t", "20", "--", "npm","run", "prod"]

  opensearch:
    restart: always
    image: opensearchproject/opensearch:2.13.0
    hostname: opensearch
    tty: true
    environment:
      - TERM="xterm-256color"
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      #- xpack.security.enabled=false # for elasticsearch
      - plugins.security.disabled=true # for opensearch
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=ASd8asfhqu2i3r@#$1546
    volumes:
      - opensearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
